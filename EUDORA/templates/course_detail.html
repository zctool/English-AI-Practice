<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>課程詳情</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        h2 {
            color: #555;
            font-size: 1.5em;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .paragraph, .sentence {
            margin-bottom: 1.5em;
            cursor: pointer;
            line-height: 1.8em;
            padding: 10px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .sentence:hover, .paragraph:hover {
            background-color: #f0f8ff;
        }
        .highlight {
            color: #5DADE2;
        }
        .playing {
            color: #28B463;
        }
        .record-controls {
            margin-top: 10px;
        }
        .record-controls button {
            padding: 8px 16px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .startRecording {
            background-color: #5DADE2;
            color: white;
        }
        .startRecording:disabled {
            background-color: #a1d0e6;
        }
        .stopRecording {
            background-color: #E74C3C;
            color: white;
        }
        .stopRecording:disabled {
            background-color: #f2a4a4;
        }
        audio.playRecording {
            width: 100%;
            margin-top: 10px;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: #dcf2ff
                /*linear-gradient(135deg, #667eea 0%, #764ba2 100%)*/
            ;
            min-height: 100vh;

            justify-content: center;
            align-items: center;
        }

        .container {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 40px;
            max-width: 800px;
            width: 90%;
            
        }

        h1 {
            color: #555555;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .date {
            text-align: center;
            color: #ffffff;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .sentence-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sentence {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .sentence:hover {
            transform: translateY(-5px);
        }

        .sentence h3 {
            color: #764ba2;
            margin-top: 0;
            font-size: 1.3em;
        }

        .english {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .translation {
            color: #666;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }
        }

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50c878;
            --accent-color: #6bb9ab;
            --text-color: #333;
            --bg-color: #fff;
            --header-height: 60px;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            line-height: 1.8;
            color: #000;
            background-color: var(--bg-color);
            padding-top: var(--header-height);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            margin-top: 40px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        header {
            background: #4e9ccf;
            color: white;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }

        header .container2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            width: 90%;
            max-width: 1200px;
            margin: auto;
            /* overflow: hidden; */
        }

        header.hidden {
            transform: translateY(-100%);
        }

        header a {
            color: white;
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        header ul {
            padding: 0;
            list-style: none;
            display: flex;
        }

        header #branding {
            display: flex;
            align-items: center;
        }

        header #branding h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        header nav {
            display: flex;
            align-items: center;
        }

        header nav li {
            margin-left: 20px;
        }

        header .highlight,
        header .current a {
            color: #87d1c3;
        }

        header a:hover,
        header a:focus {
            color: var(--accent-color);
        }

        header .logout-btn {
            background-color: #87d1c3;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        header .logout-btn:hover {
            background-color: #6bb9ab;
        }

        .content {
            padding-top: 20px;
            min-height:auto;
        }

        section {
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            background: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }

        section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        section h2 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        section h2 i {
            margin-right: 10px;
        }

        section p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .btn {
            display: inline-block;
            background: #87d1c3;
            color: white;
            /* padding: 0.8rem 1.5rem; */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .btn:hover,
        .btn:focus {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        #menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media(max-width: 768px) {
            header nav ul {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--primary-color);
                flex-direction: column;
                align-items: center;
                padding: 1rem 0;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            header nav ul.show {
                display: flex;
            }

            header nav li {
                margin: 0.5rem 0;
                width: 100%;
                text-align: center;
            }

            #menu-toggle {
                display: block;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text-color: #f0f0f0;
                --bg-color: #dcf2ff;
            }

            body {
                background-color: var(--bg-color);
            }

            section {
                background: #8db6ce;
            }
        }

        #back-to-top {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            width: 50px;
            height: 50px;
            background-color: #3776bfbd;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            text-align: center;
            line-height: 50px;
            cursor: pointer;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
        }

        #back-to-top:hover {
            background-color: #357abd;
            transform: translateY(-5px);
        }

        #back-to-top:active {
            transform: scale(0.95);
        }

        a.button {
            display: inline-block;
            /* 將<a>標籤轉換為區塊元素 */
            padding: 10px 20px;
            /* 調整內邊距，讓按鈕更大 */
            font-size: 20px;
            /* 調整字體大小 */
            color: white;
            /* 按鈕文字顏色 */
            background-color: #007bff;
            /* 按鈕背景顏色 */
            text-align: center;
            /* 文字居中 */
            text-decoration: none;
            /* 移除超連結的下劃線 */
            border-radius: 5px;
            /* 調整邊角圓滑度 */
            transition: background-color 0.3s;
            /* 添加背景色過渡效果 */
            width: auto;
        }

        /* 滑鼠懸停樣式 */
        a.button:hover {
            background-color: #0056b3;
            /* 更改滑鼠懸停時的背景色 */
        }

        /* 活動樣式 */
        a.button:active {
            background-color: #003f7f;
            /* 更改按下按鈕時的背景色 */
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        /* 下拉選單中的每個選項樣式 */
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        /* 當滑過時顯示下拉選單 */
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* 滑過選單項目的效果 */
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>

<body>
    <!-- Navbar Start -->
    <header id="main-header">
        <div class="container2">
            <div id="branding">
                <h1><span class="highlight">E</span>UDORA</h1>
            </div>
            <nav>
                <button id="menu-toggle" aria-expanded="false" aria-controls="main-nav">
                    <span class="sr-only">切換菜單</span>
                    ☰
                </button>
                <ul id="main-nav">
                    <li class="current"><a href="{{ url_for('main') }}">首頁</a></li>
                    <li class="dropdown">
                        <a href="#courses" class="dropbtn">課程</a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('all_teachers') }}">所有老師</a>
                            <a href="{{ url_for('recommended_teachers') }}">推薦的老師</a>
                            <a href="{{ url_for('selected_teachers') }}">已選擇的老師</a>
                        </div>
                    </li>
                    <li><a href="{{ url_for('vocabulary_topics') }}">單字</a></li>
                    <li><a href="{{ url_for('conversation_topics') }}">對話</a></li>
                    <li><a href="{{ url_for('account_management') }}">個人資料</a></li>
                    <li><a href="{{ url_for('logout') }}" class="logout-btn">登出</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="content">
    <div class="container">
        <h1>{{ course.name }}</h1>
        
        {% if course.type == 'conversation' %}
            <h2>對話內容</h2>
            <div id="conversation-content">
            {% for sentence in course.sentences %}
                <div class="sentence" data-audio="{{ sentence.audio_file }}" data-sentence-id="{{ sentence.id }}">
                    {{ sentence.text }}
                </div>
                <!-- 在句子下方顯示錄音按鈕 -->
                <div class="record-controls">
                    <button class="startRecording" data-sentence-id="{{ sentence.id }}" id="startRecording_{{ sentence.id }}">開始錄音</button>
                    <button class="stopRecording" data-sentence-id="{{ sentence.id }}" id="stopRecording_{{ sentence.id }}" disabled>停止錄音</button>
                    <audio class="playRecording" id="playRecording_{{ sentence.id }}" controls style="display:none;"></audio> <!-- 用於播放錄音結果 -->
                    <div class="results" id="results_{{ sentence.id }}" style="display:none;">
                        <p>音頻相似度: <span class="audio_similarity"></span></p>
                        <p>文本相似度: <span class="text_similarity"></span></p>
                        <div class="text_diff"></div>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <h2>文章內容</h2>
            <div id="article-content">
            {% for paragraph in course.content %}
                <div class="paragraph" data-audio="{{ paragraph.audio_file }}" data-paragraph-id="{{ paragraph.id }}">
                    {{ paragraph.text }}
                </div>
                <!-- 在段落下方顯示錄音按鈕 -->
                <div class="record-controls">
                    <button class="startRecording" data-paragraph-id="{{ paragraph.id }}" id="startRecording_{{ paragraph.id }}">開始錄音</button>
                    <button class="stopRecording" data-paragraph-id="{{ paragraph.id }}" id="stopRecording_{{ paragraph.id }}" disabled>停止錄音</button>
                    <audio class="playRecording" id="playRecording_{{ paragraph.id }}" controls style="display:none;"></audio> <!-- 用於播放錄音結果 -->
                    <div class="results" id="results_{{ paragraph.id }}" style="display:none;">
                        <p>音頻相似度: <span class="audio_similarity"></span></p>
                        <p>文本相似度: <span class="text_similarity"></span></p>
                        <div class="text_diff"></div>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% endif %}
    </div>

    <audio id="audioPlayer"></audio>
    </main>
    <button id="back-to-top" title="回到頂部">↑</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var textContents = document.querySelectorAll('.sentence, .paragraph');
            var audioPlayer = document.getElementById('audioPlayer');
            var mediaRecorder = null;
            var audioChunks = [];

            function stopAudioPlayback() {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }

            // 播放音檔功能
            textContents.forEach(function(item) {
                item.addEventListener('click', function() {
                    stopAudioPlayback();

                    // 重置所有文本內容的顏色
                    textContents.forEach(function(tc) {
                        tc.classList.remove('playing');
                        tc.innerHTML = tc.textContent; // 重置文本内容
                    });

                    // 播放新的音頻
                    var audioSrc = "data:audio/wav;base64," + this.getAttribute('data-audio');
                    audioPlayer.src = audioSrc;
                    audioPlayer.play();

                    // 標記當前播放的文本內容
                    this.classList.add('playing');

                    // 獲取當前點擊文本的引用
                    var textElement = this;

                    // 更新音頻播放進度時，改變字的顏色
                    audioPlayer.ontimeupdate = function() {
                        var duration = audioPlayer.duration;
                        var currentTime = audioPlayer.currentTime;
                        var progress = currentTime / duration;

                        // 計算要變色的字數
                        var totalChars = textElement.textContent.length;
                        var charsToHighlight = Math.floor(progress * totalChars);

                        // 生成高亮的文本
                        var highlightedText = '<span class="highlight">' + textElement.textContent.substring(0, charsToHighlight) + '</span>';
                        var remainingText = textElement.textContent.substring(charsToHighlight);

                        // 使用 requestAnimationFrame 使更新更流暢
                        requestAnimationFrame(function() {
                            textElement.innerHTML = highlightedText + remainingText;
                        });
                    };

                    // 音頻播放結束時，重置顏色
                    audioPlayer.onended = function() {
                        textElement.classList.remove('playing');
                        textElement.innerHTML = textElement.textContent; // 重置文本内容
                    };
                });
            });

            // 錄音功能
            document.querySelectorAll('.startRecording').forEach(function(button) {
                button.addEventListener('click', async function() {
                    var textContent = this.closest('.record-controls').previousElementSibling.textContent.trim();
                    var startButton = this;
                    var stopButton = this.closest('.record-controls').querySelector('.stopRecording');

                    if (!textContent) {
                        return;
                    }

                    try {
                        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        audioChunks = [];

                        mediaRecorder.ondataavailable = function(event) {
                            audioChunks.push(event.data);
                        };

                        startButton.disabled = true;
                        stopButton.disabled = false;

                    } catch (err) {
                        console.error('無法啟用錄音:', err);
                    }
                });
            });

            // 停止錄音並保存
            document.querySelectorAll('.stopRecording').forEach(function(button) {
                button.addEventListener('click', function() {
                    var textContent = this.closest('.record-controls').previousElementSibling.textContent.trim();
                    var playRecording = this.closest('.record-controls').querySelector('.playRecording');
                    var stopButton = this;
                    var startButton = this.closest('.record-controls').querySelector('.startRecording');
                    var resultsDiv = this.closest('.record-controls').querySelector('.results');
                    var audioSimilaritySpan = resultsDiv.querySelector('.audio_similarity');
                    var textSimilaritySpan = resultsDiv.querySelector('.text_similarity');
                    var textDiffDiv = resultsDiv.querySelector('.text_diff');
                    var feedbackMessageDiv = document.createElement('div');

                    if (!textContent) {
                        return;
                    }

                    mediaRecorder.stop();

                    mediaRecorder.onstop = function() {
                        var audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        var formData = new FormData();
                        formData.append('audio_data', audioBlob);
                        formData.append('text_content', textContent);

                        // 將 Blob 轉換成 URL 供用戶播放
                        var audioURL = URL.createObjectURL(audioBlob);
                        playRecording.src = audioURL;
                        playRecording.style.display = 'block'; // 顯示播放按鈕

                        fetch('/save_audio_by_text', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            // 顯示相似度結果
                            audioSimilaritySpan.textContent = data.similarity_score.toFixed(2);
                            textSimilaritySpan.textContent = data.text_similarity.toFixed(2);

                            // 顯示文本轉化結果
                            var recognizedUserText = `<p>用戶文本: ${data.recognized_text_user}</p>`;
                            var recognizedOriginalText = `<p>原始文本: ${data.recognized_text_original}</p>`;
                            textDiffDiv.innerHTML = recognizedUserText + recognizedOriginalText;

                            // 顯示文本差異
                            if (data.diff_ops && data.diff_ops.length > 0) {
                                var diffHtml = '<p>文本差異:</p>';
                                data.diff_ops.forEach(function(op) {
                                    diffHtml += `<p>文本1: ${op.text1} | 文本2: ${op.text2}</p>`;
                                });
                                textDiffDiv.innerHTML += diffHtml;
                            }

                            // 顯示反饋消息
                            feedbackMessageDiv.innerHTML = `<p><strong>${data.feedback_message}</strong></p>`;
                            resultsDiv.appendChild(feedbackMessageDiv);

                            resultsDiv.style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                        startButton.disabled = false;
                        stopButton.disabled = true;
                    };
                });
            });
        });

        // 當頁面滾動時，顯示或隱藏「回到頂部」按鈕
        window.addEventListener("scroll", function () {
            const backToTopButton = document.getElementById("back-to-top");
            if (window.scrollY > 300) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        });

        // 點擊「回到頂部」按鈕後，平滑滾動回到頁面頂部
        document
            .getElementById("back-to-top")
            .addEventListener("click", function () {
                window.scrollTo({
                    top: 0,
                    behavior: "smooth",
                });
            });

    </script>

    <footer style="
  background-color: #4e9ccf;
  padding: 20px;
  text-align: center;
  border-top: 2px solid #87d1c3;
">
        <p style="color: #fff; font-weight: bold; letter-spacing: 2px">
            組別: 113201 指導老師 : 林俊杰老師
        </p>
        <p style="color: #ddd">
            <a href="#" style="color: #ddd; text-decoration: none; margin: 0 10px">專題組員: 11236012 高穎萱 11236013 蔣杰森
                11236022 巫承翰 11236025
                葉于甄</a>
        </p>
    </footer>
</body>
</html>
