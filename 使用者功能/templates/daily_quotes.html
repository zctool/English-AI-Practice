<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日三句</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .conversation {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .character {
            display: flex;
            align-items: center;
        }
        .character img {
            border-radius: 50%;
            margin-right: 10px;
        }
        .recording {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>每日三句</h1>
    {% for conv in conversations %}
    <div class="conversation">
        <div class="character">
            <img src="data:image/png;base64,{{ conv.icon }}" alt="{{ conv.character_name }}" width="50" height="50">
            <strong>{{ conv.character_name }}</strong>
        </div>
        <p>英文: {{ conv.conversation_en }}</p>
        <p>中文: {{ conv.conversation_tw }}</p>
        <div class="recording">
            <button onclick="startRecording('{{ conv.id }}', this)">开始录音</button>
            <button onclick="stopRecording('{{ conv.id }}', this)" disabled>停止录音</button>
            <audio id="playback-{{ conv.id }}" controls style="display: none; margin-left: 10px;"></audio>
        </div>
        <audio controls>
            <source src="data:audio/wav;base64,{{ conv.conversation_voice }}" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    </div>
    {% endfor %}
    <script>
        let recognition;
        let mediaRecorder;
        let recordedChunks = [];
        let currentConvId;

        function startRecording(convId, startButton) {
            const stopButton = startButton.nextElementSibling;

            startButton.disabled = true;
            stopButton.disabled = false;

            recordedChunks = []; // Reset recorded chunks
            currentConvId = convId; // Set the current conversation ID

            if (!('webkitSpeechRecognition' in window)) {
                alert('Your browser does not support speech recognition.');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onresult = function(event) {
                let stt_text = event.results[0][0].transcript;

                let blob = new Blob(recordedChunks, { type: 'audio/wav' });
                let reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function() {
                    let base64data = reader.result;
                    let formData = new FormData();
                    formData.append('user_voice', base64data.split(',')[1]);
                    formData.append('stt', stt_text);
                    formData.append('conversation_id', convId);

                    fetch('/save_recording', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            document.getElementById('playback-' + convId).src = base64data;
                            document.getElementById('playback-' + convId).style.display = 'block';
                        } else {
                            alert('Failed to save voice.');
                        }
                    });
                };
            };

            recognition.start();

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    mediaRecorder.start();
                })
                .catch(error => {
                    console.error('Error accessing media devices.', error);
                    startButton.disabled = false;
                    stopButton.disabled = true;
                });
        }

        function stopRecording(convId, stopButton) {
            const startButton = stopButton.previousElementSibling;

            stopButton.disabled = true;
            startButton.disabled = false;

            mediaRecorder.stop();
            recognition.stop();
        }
    </script>
</body>
</html>
