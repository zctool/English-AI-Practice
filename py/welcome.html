<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>好煩喔</title>
</head>
<body>
<h1>測試</h1>
<button id="start-record">開始錄音</button>
<button id="stop-record" disabled>停止錄音</button>
<div id="audio-controls"></div>
<div id="transcript"></div>

<script>
  let mediaRecorder;
  let audioChunks = [];
  let audioIndex = 0;

  const startRecordButton = document.getElementById('start-record');
  const stopRecordButton = document.getElementById('stop-record');
  const audioControlsDiv = document.getElementById('audio-controls');
  const transcriptDiv = document.getElementById('transcript');

  startRecordButton.addEventListener('click', startRecording);
  stopRecordButton.addEventListener('click', stopRecording);

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = function(event) {
          audioChunks.push(event.data);
        }

        mediaRecorder.onstop = function() {
          createAudioElement(audioChunks[audioIndex], audioIndex);
          audioIndex++;
          startRecordButton.disabled = false;
          stopRecordButton.disabled = true;
        }

        mediaRecorder.start();
        startRecordButton.disabled = true;
        stopRecordButton.disabled = false;
        transcriptDiv.textContent = ""; // Clear transcript display
        startSpeechRecognition(); // Start speech recognition
      })
      .catch(function(err) {
        console.error('錯誤:', err);
      });
  }

  function stopRecording() {
    mediaRecorder.stop();
  }

  function createAudioElement(blob, index) {
    const audioUrl = URL.createObjectURL(blob);
    const audio = new Audio(audioUrl);
    const audioDiv = document.createElement('div'); // Create a new div for each recorded segment
    const playButton = document.createElement('button');
    playButton.textContent = "播放第 " + (index + 1) + " 段錄音";
    playButton.addEventListener('click', function() {
      audio.play();
    });
    const transcriptParagraph = document.createElement('p');
    transcriptParagraph.textContent =  transcriptDiv.textContent.trim(); // Use the generated transcript
    audioDiv.appendChild(playButton); // Append playback button to the div
    audioDiv.appendChild(transcriptParagraph); // Append transcript below the playback button
    audioControlsDiv.appendChild(audioDiv); // Append the div to the parent container
  }

  function startSpeechRecognition() {
    const recognition = new window.webkitSpeechRecognition();
    recognition.lang = 'en-US'; // Set language to English (United States)
    recognition.continuous = true;

    recognition.onresult = function(event) {
      const transcript = event.results[event.results.length - 1][0].transcript;
      transcriptDiv.textContent += transcript + ' ';
    };

    recognition.onerror = function(event) {
      console.error("不能用原因:", event.error);
    };

    recognition.start();
  }
</script>
</body>
</html>
